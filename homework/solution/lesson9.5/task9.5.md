# 9.5 Практическая работа
https://go.skillbox.ru/education/course/devops-kubernetes/2353200d-799f-4041-a8c4-b97451206240/homework

## Цель домашнего задания
В этом модуле вы познакомились с мониторингом и логированием в кластере Kubernetes. Цель домашней работы — попрактиковаться в использовании метрик и визуализации их в Grafana, а также настроить сбор логов c ingress-контроллера.


## Что входит в домашнее задание
Настроить дашборды состояния кластера Kubernetes.
Настроить панель логов ingress-контроллера и подсчитать число ошибок в логах.


## Подготовка окружения
Для выполнения этой домашней работы вам понадобится установить в кластер Prometheus, Grafana и Loki, а также добавить ingress-контроллер. 


Установить Prometheus, Grafana и Loki можно с помощью Helm’а.

Добавляем репозитории:
```
helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
helm repo add grafana https://grafana.github.io/helm-charts
helm repo update
```
Создаём неймспейс мониторинг:
`kubectl create ns monitoring`
И устанавливаем приложения в этот неймспейс:
```
helm upgrade --install prometheus prometheus-community/prometheus -n monitoring
helm upgrade --install loki grafana/loki-stack -n monitoring
helm upgrade --install  grafana grafana/grafana -n monitoring
```

Также нужно установить в кластер ingress-контроллер. В minikube это можно сделать простой командой:

`minikube addons enable ingress`


## Задание 1. Метрики для мониторинга кластера и их визуализация в Grafana
## Что нужно сделать

Знать текущее состояние кластера и нод кластера — это одна из самых важных задач мониторинга. Поэтому добавьте в Grafana следующие метрики:

Процент свободной оперативной памяти на ноде. Общая формула: Available memory / Total memory * 100. Тип графика — time series.
Процент свободного места на диске — точка монтирования ‘/’, исключить tmpfs. Общая формула: Available disk space (filters) / Total disk space * 100. Тип графика — time series.
Количество работающих API-серверов. Тип графика — stat.
Средняя загрузка ноды за 15 минут. Здесь обратите внимание, что просто число, например 10, ничего не даст, так как реальная загрузка будет зависеть от числа CPU на ноде. Как высчитать среднюю загрузку ноды с учётом числа CPU, можно посмотреть здесь. Тип графика — time series.
Hint: не забудьте подключить Prometheus как датастор к Grafana :)

## Что оценивается

Корректность PromQL-запросов и умение работать с Grafana.

Пришлите скрины метрик в веб-интерфейсе Grafana. Например, так:




## Задание 2. Парсинг логов
Зачастую нужно отлавливать ошибки в приложениях, для этого необходимо уметь парсить логи по заданным словам. В этом задании мы будем искать ошибки в локах ingress-контроллера. 


## Что нужно сделать

Подключите Loki как датастор к Grafana.
Создайте новую панель типа Logs и переключите Data Source на Loki.
Отфильтруйте логи, относящиеся только к ingress-контроллеру. Для этого можно использовать фильтр app_kubernetes_io_name="ingress-nginx"
Теперь из логов ingress-контроллера отфильтруйте все строки, которые содержат слово “err”. Для этого можно использовать оператор |=
Посчитайте число записей, содержащих слово “err” за период времени 24 часа.
Hint: для такого рода подсчётов удобно использовать функцию count_over_time, которая считает число записей за период времени, пример использования можно посмотреть здесь.
Так как вывод count_over_time уже не является логом, то, чтобы увидеть результат, нужно сменить тип панели с Logs на Stat.
